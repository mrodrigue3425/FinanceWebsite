{% extends "base.html" %}

{% block title %}Fixed Income Dashboard{% endblock %}

{% block head %}
    {{ super() }}
    <!-- For the chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Flatpickr dark theme or Bootstrap-like theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
{% endblock %}

<!-- Fills the main content area (inside the <main> tag) -->
{% block content %}
<!-- 1. TITLE AND DATE SELECTOR -->
    
    <div class="row g-2 mb-2">

        <div class="col-lg-7 col-md-8 col-sm-12
                    text-center text-lg-start">
            <h1 class="mb-0 text-dark fw-bold">Mexico FI Curve Monitor</h1>
        </div>

        <div class="col-lg-5 col-md-4 col-sm-12
                    d-flex justify-content-lg-end justify-content-center
                    align-items-center">
            <label for="date-selector" class="form-label fw-bold text-secondary mb-0 me-2 text-nowrap">
                Curve Date
            </label>
            <input type="text" id="date-selector" class="form-control" placeholder="YYYY-MM-DD">
        </div>
    </div>
    

    <!-- 1. SUMMARY BAR WITH KEY MACRO METRICS -->
    <div class="row mb-3 align-items-center">
        
        <!-- Metric Cards Container -->
        <div class="col-lg-12">
            <div class="row g-1 align-items-stretch">
                
                <!-- TIIE Fondeo Metric -->
                <div class="col-lg-2 col-sm-4 col-6">
                    <div class="card shadow-sm border-primary border-4 h-100">
                        <div class="card-body text-center">
                            <h6 class="card-title text-muted mb-2">TIIEF (1d)</h6>
                            <h7 class="card-subtitle fw-bold text-dark">{{summary_data.TIIEF.value}}%</h7>
                        </div>
                    </div>
                </div>
                
                <!-- TIIE Metric -->
                <div class="col-lg-2 col-sm-4 col-6">
                    <div class="card shadow-sm border-primary border-4 h-100">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle text-muted mb-2">TIIE (28d)</h6>
                            <h7 class="card-subtitle fw-bold text-dark">{{summary_data.TIIE28.value}}%</h7>
                        </div>
                    </div>
                </div>

                <!-- Target Rate Metric -->
                <div class="col-lg-2 col-sm-4 col-6">
                    <div class="card shadow-sm border-primary border-4 h-100">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle text-muted mb-2">Target Rate</h6>
                            <h7 class="card-subtitle fw-bold text-dark">{{summary_data.TargetRate.value}}%</h7>
                        </div>
                    </div>
                </div>

                <!-- Inflation Metric -->
                <div class="col-lg-2 col-sm-4 col-6">
                    <div class="card shadow-sm border-primary border-4 h-100">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle text-muted mb-2">Inflation</h6>
                            <h7 class="card-subtitle fw-bold text-dark">{{summary_data.Inflation.value}}%</h7>
                        </div>
                    </div>
                </div>

                <!-- Inflation Metric -->
                <div class="col-lg-2 col-sm-4 col-6">
                    <div class="card shadow-sm border-primary border-4 h-100">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle text-muted mb-2">UDI/MXN</h6>
                            <h7 class="card-subtitle fw-bold text-dark">{{summary_data.UDI_MXN.value}}</h7>
                        </div>
                    </div>
                </div>

                <!-- Exchange rate -->
                <div class="col-lg-2 col-sm-4 col-6">
                    <div class="card shadow-sm border-primary border-4 h-100">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle text-muted mb-2">USD/MXN</h6>
                            <h7 class="card-subtitle fw-bold text-dark">{{summary_data.USD_MXN.value}}</h7>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 2. CHART SECTION (Yield Curve) -->
    <div class="row g-4">
        
        <!-- Yield Curve Plot -->
        <div class="col-lg-12">
            <div class="card shadow-lg h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Sovereign Yield Curve</h5>
                </div>
                <div class="card-body chart-lg-height">
                    <canvas id="yieldCurveChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>

        window.onload = function() {

            const dynamicLabels = JSON.parse('{{curve_labels | tojson | safe}}')
            const dynamicRates = JSON.parse('{{curve_yields | tojson | safe}}')
            const dynamicDTMs = JSON.parse('{{curve_dtms | tojson | safe}}');
            const dynamicPrices = JSON.parse('{{curve_pxs | tojson | safe}}');

            const yieldCurveData = {
                labels: dynamicLabels,
                rates: dynamicRates,
                dtms: dynamicDTMs,
            };

            const points = dynamicDTMs.map((dtm, i) => ({
                x: dtm/365.25,
                y: dynamicRates[i]
                }));

            const yieldCurve = document.getElementById('yieldCurveChart').getContext('2d');
            new Chart(yieldCurve, {
                type: 'line',
                data: {
                    labels: yieldCurveData.labels,
                    datasets: [
                        {
                            label: 'Yield (%)',
                            data: points,
                            borderColor: '#0d6efd', 
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            showLine: false,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Yield (%)' },
                            beginAtZero: false
                        },
                        x: {
                            title: { display: true, text: 'Maturity' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            displayColors: false,
                            callbacks: {
                                title: function (context) {
                                    const index = context[0].dataIndex;
                                    return dynamicLabels[index];
                                },
                                label: function (context) {
                                    const yieldValue = context.parsed.y;
                                    const dtmValue = dynamicDTMs[context.dataIndex];
                                    const pxValue = dynamicPrices[context.dataIndex];
                                    return [
                                        `Yield (%): ${yieldValue.toFixed(8)}`,
                                        `Clean Price (MXN):  ${pxValue.toFixed(6)}`,
                                        `Days to Maturity: ${dtmValue.toLocaleString()}`
                                    ];
                                }
                            },
                            titleFont: { family: '"Helvetica Neue", Helvetica, Arial, sans-serif', size: 15 },
                            bodyFont: { family: '"Helvetica Neue", Helvetica, Arial, sans-serif', size: 13 }
                        },
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                font: { family: '"Helvetica Neue", Helvetica, Arial, sans-serif', size: 15 },
                                text: 'Term to Maturity (Years)'
                            },
                            ticks: { font: { family: '"Helvetica Neue", Helvetica, Arial, sans-serif', size: 13 } }
                        },
                        y: {
                            title: {
                                display: true,
                                font: { family: '"Helvetica Neue", Helvetica, Arial, sans-serif', size: 15 },
                                text: 'Yield to Maturity (%)'
                            },
                            ticks: { font: { family: '"Helvetica Neue", Helvetica, Arial, sans-serif', size: 13 } }
                        }
                    }
                }
            });
        };
    </script>
    <script>
        flatpickr("#date-selector", {
            dateFormat: "d-m-Y",  // same as your native input
            defaultDate: "2025-10-17",
            maxDate: "2025-10-17",
            allowInput: true,     // lets user type manually
            onOpen: function(selectedDates, dateStr, instance) {
                // optional: add Bootstrap font-family to the popup
                instance.calendarContainer.style.fontFamily = 'Inter, system-ui, sans-serif';
                instance.calendarContainer.style.fontSize = '1rem';
            }
        });
    </script>
{% endblock %}


