{% extends "base.html" %}

{% block title %}Fixed Income Dashboard{% endblock %}

{% block head %}
    {{ super() }}
    <!-- For the chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
{% endblock %}

<!-- Fills the main content area (inside the <main> tag) -->
{% block content %}
 
    <!-- 1. SUMMARY BAR WITH KEY METRICS AND DATE SELECTOR -->
    
    <h1 class="mb-4 text-dark fw-bold">Market Overview</h1>

    <!-- 1. SUMMARY BAR WITH KEY METRICS AND DATE SELECTOR -->
    <div class="row mb-5 align-items-center">
        <!-- Date Selector -->
        <div class="col-lg-3 col-md-4 mb-3">
            <label for="date-selector" class="form-label fw-bold text-secondary">Data As Of</label>
            <input type="date" id="date-selector" class="form-control" value="2025-10-17" max="2025-10-17">
        </div>

        <!-- Metric Cards Container (Now uses col-lg-9 to keep layout similar to previous version) -->
        <div class="col-lg-9 col-md-8">
            <div class="row g-3">
                
                <!-- NEW: TIIE Fondeo Metric -->
                <!-- Adjusted to col-lg-3 to fit 4 cards across a 12-column row -->
                <div class="col-lg-2 col-md-6 col-sm-6">
                    <div class="card shadow-sm border-start border-danger border-5 h-100">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-2">TIIEF (1d)</h6>
                            <h7 class="card-subtitle fw-bold text-danger">{{summary_data.TIIEF.value}}%</h7>
                            <h7 class="card-title mb-2 text-muted">Published</h7>
                            <h7 class="card-subtitle text-muted">{{summary_data.TIIEF.date}}</h7>
                        </div>
                    </div>
                </div>
                
                <!-- TIIE Metric -->
                <!-- Adjusted to col-lg-3 to fit 4 cards across a 12-column row -->
                <div class="col-lg-2 col-md-6 col-sm-6">
                    <div class="card shadow-sm border-start border-primary border-5 h-100">
                        <div class="card-body">
                            <h6 class="card-subtitle text-muted mb-2">TIIE (28d)</h6>
                            <h7 class="card-subtitle fw-bold text-primary">{{summary_data.TIIE28.value}}%</h7>
                            <h7 class="card-title mb-2 text-muted">Published</h7>
                            <h7 class="card-subtitle text-muted">{{summary_data.TIIE28.date}}</h7>
                        </div>
                    </div>
                </div>

                <!-- Target Rate Metric -->
                <!-- Adjusted to col-lg-3 to fit 4 cards across a 12-column row -->
                <div class="col-lg-2 col-md-6 col-sm-6">
                    <div class="card shadow-sm border-start border-success border-5 h-100">
                        <div class="card-body">
                            <h6 class="card-subtitle text-muted mb-2">Target Rate</h6>
                            <h7 class="card-subtitle fw-bold text-success">{{summary_data.TargetRate.value}}%</h7>
                            <h7 class="card-title mb-2 text-muted">Published</h7>
                            <h7 class="card-subtitle text-muted">{{summary_data.TargetRate.date}}</h7>
                        </div>
                    </div>
                </div>

                <!-- Inflation Metric -->
                <!-- Adjusted to col-lg-3 to fit 4 cards across a 12-column row -->
                <div class="col-lg-2 col-md-6 col-sm-6">
                    <div class="card shadow-sm border-start border-warning border-5 h-100">
                        <div class="card-body">
                            <h6 class="card-subtitle text-muted mb-2">Inflation</h6>
                            <h7 class="card-subtitle fw-bold text-warning">{{summary_data.Inflation.value}}%</h7>
                            <h7 class="card-title mb-2 text-muted">Published</h7>
                            <h7 class="card-subtitle text-muted">{{summary_data.Inflation.date}}</h7>
                        </div>
                    </div>
                </div>
                <!-- Inflation Metric -->
                <div class="col-lg-2 col-md-6 col-sm-6">
                    <div class="card shadow-sm border-start border-secondary border-5 h-100">
                        <div class="card-body">
                            <h6 class="card-subtitle text-muted mb-2">UDI/MXN</h6>
                            <h7 class="card-subtitle fw-bold text-secondary">{{summary_data.UDI_MXN.value}}</h7>
                            <h7 class="card-title mb-2 text-muted">Published</h7>
                            <h7 class="card-subtitle text-muted">{{summary_data.UDI_MXN.date}}</h7>
                        </div>
                    </div>
                </div>
                <!-- Exchange rate -->
                <div class="col-lg-2 col-md-6 col-sm-6">
                    <div class="card shadow-sm border-start border-dark border-5 h-100">
                        <div class="card-body">
                            <h6 class="card-subtitle text-muted mb-2">USD/MXN</h6>
                            <h7 class="card-subtitle fw-bold text-dark">{{summary_data.USD_MXN.value}}</h7>
                            <h7 class="card-title mb-2 text-muted">Published</h7>
                            <h7 class="card-subtitle text-muted">{{summary_data.USD_MXN.date}}</h7>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 2. TWO-COLUMN CHART SECTION (Yield Curve & Time Series) -->
    <div class="row g-4">
        
        <!-- Left Column: Yield Curve Plot -->
        <div class="col-lg-12">
            <div class="card shadow-lg h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Mexico Sovereign Yield Curve</h5>
                </div>
                <div class="card-body chart-lg-height">
                    <canvas id="yieldCurveChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>

        window.onload = function() {
            
            const dynamicLabels = JSON.parse('{{curve_labels | tojson | safe}}')
            const dynamicRates = JSON.parse('{{curve_yields | tojson | safe}}')
            const dynamicDTMs = JSON.parse('{{curve_dtms | tojson | safe}}');
            const dynamicPrices = JSON.parse('{{curve_pxs | tojson | safe}}');

            const yieldCurveData = {
                labels: dynamicLabels,
                rates: dynamicRates,
                dtms: dynamicDTMs,
            };

            const points = dynamicDTMs.map((dtm, i) => ({
                x: dtm/365.25,
                y: dynamicRates[i]
                }));

            const yieldCurve = document.getElementById('yieldCurveChart').getContext('2d');
            new Chart(yieldCurve, {
                type: 'line',
                data: {
                    labels: yieldCurveData.labels,
                    datasets: [
                        {
                            label: 'Yield (%)',
                            data: points,
                            borderColor: '#0d6efd', 
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            showLine: false,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Yield (%)' },
                            beginAtZero: false
                        },
                        x: {
                            title: { display: true, text: 'Maturity' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            displayColors: false,
                            callbacks: {
                                title: function (context) {
                                    const index = context[0].dataIndex;
                                    return dynamicLabels[index];
                                },
                                label: function (context) {
                                    const yieldValue = context.parsed.y;
                                    const dtmValue = dynamicDTMs[context.dataIndex];
                                    const pxValue = dynamicPrices[context.dataIndex];
                                    return [
                                        `Yield (%): ${yieldValue.toFixed(8)}`,
                                        `Clean Price (MXN):  ${pxValue.toFixed(6)}`,
                                        `Days to Maturity: ${dtmValue.toLocaleString()}`
                                    ];
                                }
                            }
                        },
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Term to Maturity (Years)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Yield to Maturity (%)'
                            }
                        }
                    }
                }
            });
        };
    </script>
{% endblock %}


