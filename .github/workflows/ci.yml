name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build C++ Python extension
      run: |
        python setup.py build_ext --inplace

    - name: Build and run C++ engine tests
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ libgtest-dev cmake

        sudo cmake -S /usr/src/gtest -B /usr/src/gtest/build
        sudo cmake --build /usr/src/gtest/build --target gtest gtest_main

        g++ -std=c++17 \
            cpp_engine/tests/test_price_to_yield.cpp \
            cpp_engine/price_to_yield.cpp \
            -o cpp_engine/tests/test_price_to_yield \
            -lgtest -lgtest_main -pthread

        ./cpp_engine/tests/test_price_to_yield

    - name: Run Python tests
      env:
        BANXICO_API_KEY: ${{ secrets.BANXICO_API_KEY }}
      run: |
        pytest -q
